#node-static-asset

node-static-asset is *the best* static asset manager for Node.JS, designed for use with Express, Jade,
Stylus, and Browserify. This project aims to solve all application deployment problems. No thinking
required.

## Install

`npm install static-asset`

...and done.

## Basic Usage

Usually, this should be good enough to get started. Stylus, CSS, Jade templates, and client-side
JavaScript are automatically handled for you.

```javascript
var app = require('express').createServer();
var asset = require('static-asset');
asset.useDefaultConfiguration();
asset.deploy();
app.use(asset.middleware);
```

## Default Configuration

By default, static-asset does the following:

* Development Environment
	* When applicable, all files are compiled with debugging information, uncompressed
* Production Environment
	* When applicable, all files are minified and compiled without debugging information
* .css and .styl files are rendered using Stylus
* .jade files are compiled and written to *.js files
* .coffee files are compiled to *.js files (not working yet...)
* index.js file is bundled using Browserify
* Assumes the following directory structure for your project:

```
	project/
		/server
			The location of app.js
		/client
			All client-side .js and .coffee files
			/lib
				Client-side libraries
		/views
			.jade and .html files are in here
		/css
			.styl and .css source files are in here
		/public
			All of the content publicly available to the WWW
			/images
				Contains all of your images (png, jpeg, gif, bmp, etc.)
			/assets
				This dir may be generated by static-asset and can be wiped at any time!
			/abcdef
				This directory will never be touched. It's safe to put files in /static
```

## Advanced Usage

```javascript
var app = require('express').createServer();
var asset = require('static-asset');
var stylus = require('stylus');
asset.useDefaultConfiguration();

//Start overriding some configuration
asset.configure(function() {
	//Environment-specific configuration goes here... 'this' refers to 'asset'
	
	//CSS
	this.register(['styl', 'css'], function(body, filename, cb) {
		//'this' still refers to 'asset'
		stylus(body, this.get('stylus'))
			.set('filename', filename)
			.set('compress',  || true)
			.include(__dirname + '/../css/')
			.import(__dirname + '/../css/mixins.styl')
			.import(__dirname + '/../css/colors.styl')
			.render(cb);
	});
	//Error-handling
	this.on('error', function(err) {
		//Do something about some error
		console.log('This asset is being an ' + "asset".substring(0, 3) + ':', err.filename);
	});
});

asset.configure('development', function() {
	//Put your development-specific config here...
});
asset.deploy();
app.use(asset.middleware() );

asset.on('deployed', function() {
	console.log("Yay! It worked!");
});
```

## API

### asset.configure([environment,] fn)

TJ-style configure. Define a callback function for the given `environment` (or all environments)
with callback `fn`.

### asset.useDefaultConfiguration()

Configures static-asset with the default built-in configuration. Usually, you will want to call this
first, and then override settings manually, if needed.

### asset.register(extension, fn)

Register a handler for the given file `extension`. `fn` can manipulate the body of the file
and output the contents back to static-asset. `fn` should be of the form: `function (body, filename, cb)`
with `cb` of the form `function (err, new_body)`. You can also pass an array of extensions as in
`asset.register(['css', 'styl'], function() {...});`

If you call `asset.register` again with the same file extension, the previous handler will be replaced.

### asset.output(fn)

Register a handler to deploy the static assets. `fn` is of the form: `function (body, filename, cb)`
with `cb` of the form `function (err)`

static-asset comes with many built-in output functions for your convenience:
	* Deploy the assets to a local directory? Use `asset.output.local`
		* Assumes directory structure above.
		* Caution: May overwrite all contents of /public/assets
	* Deploy the assets to S3? Use `asset.output.s3(opts)`

By default, static-asset will use `asset.output.local` in production and development environments.
If you call `asset.output` again, the original output function will be replaced by `fn`.

Example:

```javascript
asset.configure('production', function() {
	asset.output(asset.output.s3({
		'key': 'my_key',
		'secret': 'my_secret_key',
		'bucket': 'my_bucket',
		'path': ... //optional path prepended to filename
		'headers': ... //optional headers
	})
	.use(function(req) {
		//`use()` is optional, but allows you to do something with the HTTP request Object...
		req.end(); //Be sure to call end() if you introduce middleware
	}) );
}
asset.configure('development', function() {
	//Deploy to /public/assets
	asset.output(asset.output.local);
	app.use(asset.middleware() );
});
```

### asset.deploy(cb)

Compiles and deploys all static assets according to the options specified. Calls `cb` of the form
`function (err)` when complete. Also, the 'deployed' signal is emitted after the callback is called.

### asset.middleware()

Returns an Express middleware function of the form: `function (req, res, next)`.
The middleware is only useful when asset.output.local is set as the output function. In this case,
if a compiled static asset is requested, strong caching headers will be added to the response. In
addition, if the client sends "If-Modified-Since" header, then the middleware may respond with 304
Not Modified, if applicable. Otherwise, the request is passed to the `next` middleware to handle the
request; presumably, a static file server middleware (i.e. connect.static) will handle the request.

Also, the middleware exposes the getURLFingerprint function by adding it to each HTTP request object.
If Express is used, it is also exposed directly to views via `res.local(...)`.

Otherwise, if asset.output.local is not used, the default middleware does nothing.

### asset.use(fn)

Overrides the default middleware with your own function.

### asset.version(fn)

`fn` allows static-asset to determine the version number of an asset. `fn` must be of the form:
`function(body, filename, cb)` with `cb` of the form `function(err, version_number)`.

This allows static-asset to implement strong caching of assets using URL fingerprinting. By default,
the version number of an asset is the UNIX timestamp (in seconds, not milliseconds) of the file's
last modification date.

### asset.getURLFingerprint(filename, cb)

Generates the URL fingerprint for the specified `filename`, using the function provided in
`asset.version(fn)`. `cb` is of the form `function(err, urlFingerprint)`.

URL fingerprints are of the form: base_path + base_filename '-' version_number '.' file_extension
For example: /css/main.css might have a URL fingerprint of /css/main-1318365481.css

### asset.cacheFingerprints(boolean)

Tells static-asset whether or not it should cache URL fingerprints. By default, caching is enabled
in production, but disabled in development. This means that, in a production environment, a URL
fingerprint for a given file is only generated once and only the first time that fingerprint is
requested. In development environments where static assets may be changed, the URL fingerprints may
change; and therefore, the web browser will be forced to reload the file.

### asset.set(key, value)

Convenience function to store a key-value pair for later use.

### asset.get(key, value)

Convenience function to retrieve a key-value pair that was stored using `set()`.

### Event: error

'error' is emitted whenever an error occurs. Usually, the error object will contain a filename and
perhaps a lineno properly, if applicable.

### Event: deployed

'deployed' is emitted when deployment is complete.